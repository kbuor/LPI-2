+----------------------+
|       CentOS 7       |
|  mail.kbuor.website  |
|     103.89.85.24     |
+----------------------+

# Prepare CentOS
# Disable Firewall
systemctl stop firewalld
systemctl disable firewalld

# Disable SELinux
setenforce 0
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux
sed -i 's/SELINUX=permissive/SELINUX=disabled/g' /etc/sysconfig/selinux

# Install common package
yum install -y open-vm-tools epel-release wget zip bind-utils net-tools
yum update -y

# Check your hostname correctly
hostnamectl set-hostname mail.kbuor.website
hostnamectl

# Add to end of your host file your IP address and Hostname
echo '103.89.85.24 mail.kbuor.website mail' >> /etc/hosts

reboot

# Remove Postfix
yum remove postfix -y

# Install dependence package
yum -y install unzip net-tools sysstat openssh-clients perl-core libaio nmap-ncat libstdc++.so.6

# Download Zimbra
cd /tmp
wget https://files.zimbra.com/downloads/8.8.15_GA/zcs-8.8.15_GA_3869.RHEL7_64.20190918004220.tgz

# Extract downloaded file
tar -xzvf zcs-8*
cd zcs-8*
chmod +x install.sh

# Check DNS record
dig A mail.kbuor.website

            ; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.10 <<>> A mail.kbuor.website
            ;; global options: +cmd
            ;; Got answer:
            ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21229
            ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

            ;; OPT PSEUDOSECTION:
            ; EDNS: version: 0, flags:; udp: 512
            ;; QUESTION SECTION:
            ;mail.kbuor.website.            IN      A

            ;; ANSWER SECTION:
            mail.kbuor.website.     300     IN      A       103.89.85.24

            ;; Query time: 50 msec
            ;; SERVER: 8.8.8.8#53(8.8.8.8)
            ;; WHEN: Sat Oct 29 10:01:54 +07 2022
            ;; MSG SIZE  rcvd: 63

dig MX kbuor.website

            ; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.10 <<>> MX kbuor.website
            ;; global options: +cmd
            ;; Got answer:
            ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 5960
            ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

            ;; OPT PSEUDOSECTION:
            ; EDNS: version: 0, flags:; udp: 512
            ;; QUESTION SECTION:
            ;kbuor.website.                 IN      MX

            ;; ANSWER SECTION:
            kbuor.website.          300     IN      MX      10 mail.kbuor.website.

            ;; Query time: 51 msec
            ;; SERVER: 8.8.8.8#53(8.8.8.8)
            ;; WHEN: Sat Oct 29 10:02:17 +07 2022
            ;; MSG SIZE  rcvd: 63
            

# Recommend run script via tmux
cd /tmp/zcs-8*
./install.sh

...........

# Update SSH Key for zimbra user
sudo -u zimbra -i
zmupdateauthkeys
exit

# Install Syslog for Administration Dashboard
/opt/zimbra/libexec/zmsyslogsetup

# Enable ClamAV Antivirus
su - zimbra
zmprov mcf zimbraAttachmentsScanURL clam://localhost:3310/
zmprov mcf zimbraAttachmentsScanEnabled TRUE

# Generate DKIM record
/opt/zimbra/libexec/zmdkimkeyutil -a -d kbuor.website

# Add DNS record in DNS Server
# DKIM: 
# DMARC:
_DMARC IN v=DMARC1; p=reject; pct=100; rua=mailto:admin@kbuor.website

# SPF:
@ IN v=spf1 ip4:103.89.85.24 include:kbuor.website mx -all


# Secure Zimbra with Let's Encrypt
(Login as root)
# Install Certbot package
yum install -y certbot

# Obtaining an SSL Certificate
certbot certonly -d mail.kbuor.website

# Configure SSL Certificate for Zimbra
su - zimbra
zmcontrol stop

# Copy certificate file to correct location
mkdir /opt/zimbra/ssl/letsencrypt
cp /etc/letsencrypt/live/mail.kbuor.website/* /opt/zimbra/ssl/letsencrypt/
cd /opt/zimbra/ssl/letsencrypt/
echo > chain.pem

# Paste content below to chain.pem file

-----BEGIN CERTIFICATE-----
MIIFMTCCBBmgAwIBAgISA7KAKK5msndhydn4BNZP5TWiMA0GCSqGSIb3DQEBCwUA
MDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQD
EwJSMzAeFw0yMjAzMjMwNTI5MThaFw0yMjA2MjEwNTI5MTdaMCAxHjAcBgNVBAMT
FW1haWwuZG90cnVuZ3F1YW4uc2l0ZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC
AQoCggEBAKyO0W6G9PDG2E3k7E6fGvInutJ0+ICGm3rZkmVQtiihxDCvbeLbbGgQ
ozz2IXdd57Rs2tn0daXAnHhhYBp9LzuuktLIn6fZK6+m1lOQr7/D8P6Z2x8eqYVr
sppuQm3NgCe68ZNqbBrCZ9BLFAhSr/s3T9tsmwAJ2zGjC9W3jLklJFl527pHzhu3
IUsLorVUuYC0FVEQKPSJjoTy8x4EMkggp17ec7vZh7t8s8PoICi3wGtDz72L+9FC
43tJTQ3Z6OD/5oU/zBw4wttiRSdi0J3xlvYEjp1kVbQuKDAEZEgG+ed9nqeZ+wHB
sCl5p+4J0X0gIi/xwlSn5L3k9clsljcCAwEAAaOCAlEwggJNMA4GA1UdDwEB/wQE
AwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwDAYDVR0TAQH/BAIw
ADAdBgNVHQ4EFgQUYvcEWd6L1cE4BYjbKheQecSjMWMwHwYDVR0jBBgwFoAUFC6z
F7dYVsuuUAlA5h+vnYsUwsYwVQYIKwYBBQUHAQEESTBHMCEGCCsGAQUFBzABhhVo
dHRwOi8vcjMuby5sZW5jci5vcmcwIgYIKwYBBQUHMAKGFmh0dHA6Ly9yMy5pLmxl
bmNyLm9yZy8wIAYDVR0RBBkwF4IVbWFpbC5kb3RydW5ncXVhbi5zaXRlMEwGA1Ud
IARFMEMwCAYGZ4EMAQIBMDcGCysGAQQBgt8TAQEBMCgwJgYIKwYBBQUHAgEWGmh0
dHA6Ly9jcHMubGV0c2VuY3J5cHQub3JnMIIBBQYKKwYBBAHWeQIEAgSB9gSB8wDx
AHcA36Veq2iCTx9sre64X04+WurNohKkal6OOxLAIERcKnMAAAF/tXckiQAABAMA
SDBGAiEA8vwBUawi1GSn4Ly0rRKdyEUYSilMpzn3jrphPUCBGfsCIQCqRozDbEZ3
JfQMnoFcrAhKONru79n4AvRF9GDpGxN3JwB2AEalVet1+pEgMLWiiWn0830RLEF0
vv1JuIWr8vxw/m1HAAABf7V3JLIAAAQDAEcwRQIgeVMJ5zV+OXAgpyALWopypgyO
p8FiyU6ZOn2hJS1FUCwCIQCdZYH4ooMucAdCc+Mru7iO7Tc+Czx48MyDfmBzauRO
KzANBgkqhkiG9w0BAQsFAAOCAQEATaHH+j9fdvo/yD++NYzHBVu9ka03xNpSAr1i
EjPtk+xYc7qy84nAxAQ6HOCLdMGUSRyv3os8Aa+l+CoV+5FiShphuHza0y6byZzK
FZyzpinijZvx1Lz/GEZLDG245RzagO5vLXFv8Hv5w14z9/PQcAd/eEy2f0iY060b
bDYZxZcENhA9dgu+M4xVCMEFUtCAqLAmY+A42bJPIQJ0nJnMBmNUG9vW9PfI4Ga7
X5/C+3bysuR59B1IpJdaL2NE3vP5eV9XDEwWu2jVi84lTycrjReLJVWiCj3Tf1VS
Bd7zmPxYBSLJvHXh7uVmJ/8a2i+0mazzZv7fN1n1uspQ/xoh0g==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIFFjCCAv6gAwIBAgIRAJErCErPDBinU/bWLiWnX1owDQYJKoZIhvcNAQELBQAw
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMjAwOTA0MDAwMDAw
WhcNMjUwOTE1MTYwMDAwWjAyMQswCQYDVQQGEwJVUzEWMBQGA1UEChMNTGV0J3Mg
RW5jcnlwdDELMAkGA1UEAxMCUjMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQC7AhUozPaglNMPEuyNVZLD+ILxmaZ6QoinXSaqtSu5xUyxr45r+XXIo9cP
R5QUVTVXjJ6oojkZ9YI8QqlObvU7wy7bjcCwXPNZOOftz2nwWgsbvsCUJCWH+jdx
sxPnHKzhm+/b5DtFUkWWqcFTzjTIUu61ru2P3mBw4qVUq7ZtDpelQDRrK9O8Zutm
NHz6a4uPVymZ+DAXXbpyb/uBxa3Shlg9F8fnCbvxK/eG3MHacV3URuPMrSXBiLxg
Z3Vms/EY96Jc5lP/Ooi2R6X/ExjqmAl3P51T+c8B5fWmcBcUr2Ok/5mzk53cU6cG
/kiFHaFpriV1uxPMUgP17VGhi9sVAgMBAAGjggEIMIIBBDAOBgNVHQ8BAf8EBAMC
AYYwHQYDVR0lBBYwFAYIKwYBBQUHAwIGCCsGAQUFBwMBMBIGA1UdEwEB/wQIMAYB
Af8CAQAwHQYDVR0OBBYEFBQusxe3WFbLrlAJQOYfr52LFMLGMB8GA1UdIwQYMBaA
FHm0WeZ7tuXkAXOACIjIGlj26ZtuMDIGCCsGAQUFBwEBBCYwJDAiBggrBgEFBQcw
AoYWaHR0cDovL3gxLmkubGVuY3Iub3JnLzAnBgNVHR8EIDAeMBygGqAYhhZodHRw
Oi8veDEuYy5sZW5jci5vcmcvMCIGA1UdIAQbMBkwCAYGZ4EMAQIBMA0GCysGAQQB
gt8TAQEBMA0GCSqGSIb3DQEBCwUAA4ICAQCFyk5HPqP3hUSFvNVneLKYY611TR6W
PTNlclQtgaDqw+34IL9fzLdwALduO/ZelN7kIJ+m74uyA+eitRY8kc607TkC53wl
ikfmZW4/RvTZ8M6UK+5UzhK8jCdLuMGYL6KvzXGRSgi3yLgjewQtCPkIVz6D2QQz
CkcheAmCJ8MqyJu5zlzyZMjAvnnAT45tRAxekrsu94sQ4egdRCnbWSDtY7kh+BIm
lJNXoB1lBMEKIq4QDUOXoRgffuDghje1WrG9ML+Hbisq/yFOGwXD9RiX8F6sw6W4
avAuvDszue5L3sz85K+EC4Y/wFVDNvZo4TYXao6Z0f+lQKc0t8DQYzk1OXVu8rp2
yJMC6alLbBfODALZvYH7n7do1AZls4I9d1P4jnkDrQoxB3UqQ9hVl3LEKQ73xF1O
yK5GhDDX8oVfGKF5u+decIsH4YaTw7mP3GFxJSqv3+0lUFJoi5Lc5da149p90Ids
hCExroL1+7mryIkXPeFM5TgO9r0rvZaBFOvV2z0gp35Z0+L4WPlbuEjN/lxPFin+
HlUjr8gRsI3qfJOQFy/9rKIJR0Y/8Omwt/8oTWgy1mdeHmmjk7j1nYsvC9JSQ6Zv
MldlTTKB3zhThV1+XWYp6rjd5JW1zbVWEkLNxE7GJThEUG3szgBVGP7pSWTUTsqX
nLRbwHOoq7hHwg==
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIFazCCA1OgAwIBAgIRAIIQz7DSQONZRGPgu2OCiwAwDQYJKoZIhvcNAQELBQAw
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4
WhcNMzUwNjA0MTEwNDM4WjBPMQswCQYDVQQGEwJVUzEpMCcGA1UEChMgSW50ZXJu
ZXQgU2VjdXJpdHkgUmVzZWFyY2ggR3JvdXAxFTATBgNVBAMTDElTUkcgUm9vdCBY
MTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBAK3oJHP0FDfzm54rVygc
h77ct984kIxuPOZXoHj3dcKi/vVqbvYATyjb3miGbESTtrFj/RQSa78f0uoxmyF+
0TM8ukj13Xnfs7j/EvEhmkvBioZxaUpmZmyPfjxwv60pIgbz5MDmgK7iS4+3mX6U
A5/TR5d8mUgjU+g4rk8Kb4Mu0UlXjIB0ttov0DiNewNwIRt18jA8+o+u3dpjq+sW
T8KOEUt+zwvo/7V3LvSye0rgTBIlDHCNAymg4VMk7BPZ7hm/ELNKjD+Jo2FR3qyH
B5T0Y3HsLuJvW5iB4YlcNHlsdu87kGJ55tukmi8mxdAQ4Q7e2RCOFvu396j3x+UC
B5iPNgiV5+I3lg02dZ77DnKxHZu8A/lJBdiB3QW0KtZB6awBdpUKD9jf1b0SHzUv
KBds0pjBqAlkd25HN7rOrFleaJ1/ctaJxQZBKT5ZPt0m9STJEadao0xAH0ahmbWn
OlFuhjuefXKnEgV4We0+UXgVCwOPjdAvBbI+e0ocS3MFEvzG6uBQE3xDk3SzynTn
jh8BCNAw1FtxNrQHusEwMFxIt4I7mKZ9YIqioymCzLq9gwQbooMDQaHWBfEbwrbw
qHyGO0aoSCqI3Haadr8faqU9GY/rOPNk3sgrDQoo//fb4hVC1CLQJ13hef4Y53CI
rU7m2Ys6xt0nUW7/vGT1M0NPAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNV
HRMBAf8EBTADAQH/MB0GA1UdDgQWBBR5tFnme7bl5AFzgAiIyBpY9umbbjANBgkq
hkiG9w0BAQsFAAOCAgEAVR9YqbyyqFDQDLHYGmkgJykIrGF1XIpu+ILlaS/V9lZL
ubhzEFnTIZd+50xx+7LSYK05qAvqFyFWhfFQDlnrzuBZ6brJFe+GnY+EgPbk6ZGQ
3BebYhtF8GaV0nxvwuo77x/Py9auJ/GpsMiu/X1+mvoiBOv/2X/qkSsisRcOj/KK
NFtY2PwByVS5uCbMiogziUwthDyC3+6WVwW6LLv3xLfHTjuCvjHIInNzktHCgKQ5
ORAzI4JMPJ+GslWYHb4phowim57iaztXOoJwTdwJx4nLCgdNbOhdjsnvzqvHu7Ur
TkXWStAmzOVyyghqpZXjFaH3pO3JLF+l+/+sKAIuvtd7u+Nxe5AW0wdeRlN8NwdC
jNPElpzVmbUq4JUagEiuTDkHzsxHpFKVK7q4+63SM1N95R1NbdWhscdCb+ZAJzVc
oyi3B43njTOQ5yOf+1CceWxG1bQVs5ZufpsMljq4Ui0/1lvh+wjChP4kqKOJ2qxq
4RgqsahDYVvTH9w7jXbyLeiNdd8XM2w9U/t7y0Ff/9yi0GE44Za4rF2LN9d11TPA
mRGunUHBcnWEvgJBQl9nJEiU0Zsnvgc/ubhPgXRR4Xq37Z0j4r7g1SgEEzwxA57d
emyPxgcYxn/eR44/KJ4EBs+lVDR3veyJm+kXQ99b21/+jh5Xos1AnX5iItreGCc=
-----END CERTIFICATE-----


chown zimbra:zimbra /opt/zimbra/ssl/letsencrypt/*

# Verify SSL certificate
cd /opt/zimbra/ssl/letsencrypt
/opt/zimbra/bin/zmcertmgr verifycrt comm privkey.pem cert.pem chain.pem

# Deploy SSL certificate
cp /opt/zimbra/ssl/letsencrypt/privkey.pem /opt/zimbra/ssl/zimbra/commercial/commercial.key
chown zimbra:zimbra /opt/zimbra/ssl/zimbra/commercial/commercial.key
cd /opt/zimbra/ssl/letsencrypt
/opt/zimbra/bin/zmcertmgr deploycrt comm cert.pem chain.pem

# Start zimbra service
zmcontrol restart
